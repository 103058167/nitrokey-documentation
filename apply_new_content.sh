admin_mail_address="ben@dotplex.com"

echo "$(date) [apply_new_content.sh] Content change triggered." >> /var/www/sphinx/logs_sphinx/webhook.log

echo -n "$(date) [apply_new_content.sh] Pulling Repo..." >> /var/www/sphinx/logs_sphinx/webhook.log

cd /var/www/sphinx/sphinx/nitrokey-documentation

# pull new content
git pull

if [ $? -eq 0 ]
then
	echo "DONE" >> /var/www/sphinx/logs_sphinx/webhook.log
else
	echo "FAILED" >> /var/www/sphinx/logs_sphinx/webhook.log
	echo "Building Docs.nitrokey.com â€“ pulling repo FAILED." | mail -s "[Sphinx] Pulling Repo FAILED." $admin_mail_address

fi


# build english version
echo -n "$(date) [apply_new_content.sh] Building englisch Versions..." >> /var/www/sphinx/logs_sphinx/webhook.log

sphinx-build -a -D language='en' -b html . /var/www/sphinx/www/docs.nitrokey.com_en_temp

if [ $? -eq 0 ]
then
	echo "DONE" >> /var/www/sphinx/logs_sphinx/webhook.log
	mv /var/www/sphinx/www/static/?? /var/www/sphinx/www/docs.nitrokey.com_en_temp/
	rm /var/www/sphinx/www/static -r
	mv /var/www/sphinx/www/docs.nitrokey.com_en_temp /var/www/sphinx/www/static
else
	echo echo "FAILED" >> /var/www/sphinx/logs_sphinx/webhook.log
	echo "Building Docs.nitrokey.com Language EN FAILED. " | mail -s "[Sphinx] Building Language EN FAILED." $admin_mail_address
fi


echo -n "$(date) [apply_new_content.sh] Building /locales/ ..." >> /var/www/sphinx/logs_sphinx/webhook.log

# generate language files and push
sphinx-build -b gettext . ./locales/
sphinx-intl update -p ./locales/ -l de -l fr -l es -l nl -l it -l ja -l ru -l zh_CN -l el
if [ $? -eq 0 ]
then
	echo "DONE" >> /var/www/sphinx/logs_sphinx/webhook.log
else
	echo "FAILED" >> /var/www/sphinx/logs_sphinx/webhook.log
	echo "Building  /locales/ FAILED." | mail -s "[Sphinx] Building Locales FAILED." $admin_mail_address

fi

echo -n "$(date) [apply_new_content.sh] Pushing upstream ..." >> /var/www/sphinx/logs_sphinx/webhook.log

git add --all
git commit -m "Language Files generated by Sphinx"
git push

echo "DONE" >> /var/www/sphinx/logs_sphinx/webhook.log
