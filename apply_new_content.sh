#!/bin/bash
source /var/www/sphinx/sphinx/nitrokey-documentation/config.sh

echo "$(date) [apply_new_content.sh] ($BASHPID) Content change triggered." >> /var/www/sphinx/logs_sphinx/webhook.log

echo "$(date) [apply_new_content.sh] ($BASHPID) Pulling Repo..." >> /var/www/sphinx/logs_sphinx/webhook.log

cd /var/www/sphinx/sphinx/nitrokey-documentation

# pull new content
git pull

if [ $? -eq 0 ]
then
	echo "$(date) [apply_new_content.sh] ($BASHPID) Pulling Repo...DONE" >> /var/www/sphinx/logs_sphinx/webhook.log
else
	echo "$(date) [apply_new_content.sh] ($BASHPID) Pulling Repo...FAILED" >> /var/www/sphinx/logs_sphinx/webhook.log
	echo "$(date) [apply_new_content.sh] ($BASHPID) Pulling Repo...FAILED." | mail -s "[Sphinx] Pulling Repo FAILED." $admin_mail_address
	exit
fi


# build english version
echo -n "$(date) [apply_new_content.sh] ($BASHPID) Building englisch Versions..." >> /var/www/sphinx/logs_sphinx/webhook.log


if [ $build_mode == "full" ]
then
	sphinx-build -a -D language='en' -b html . /var/www/sphinx/www/docs.nitrokey.com_en_temp
	status=$?
elif [ $build_mode == "incremental" ]
then
	sphinx-build -D language='en' -b html . /var/www/sphinx/www/docs.nitrokey.com_en_temp
	status=$?
else
	echo "Building Docs.nitrokey.com Language $lang FAILED. Sphinx build mode in config.sh unkown." | mail -s "[Sphinx] ($BASHPID) Building Language $lang FAILED." $admin_mail_address
fi

if [ $status -eq 0 ]
then
	echo "$(date) [apply_new_content.sh] ($BASHPID) Building englisch Versions...DONE" >> /var/www/sphinx/logs_sphinx/webhook.log

	for lang in "${languages[@]}"
	do
		mv /var/www/sphinx/www/static/$lang /var/www/sphinx/www/docs.nitrokey.com_en_temp/
	done
	rm /var/www/sphinx/www/static -r
	mv /var/www/sphinx/www/docs.nitrokey.com_en_temp /var/www/sphinx/www/static
else
	echo echo "$(date) [apply_new_content.sh] Building englisch Versions...FAILED" >> /var/www/sphinx/logs_sphinx/webhook.log
	echo "Building Docs.nitrokey.com Language EN FAILED. " | mail -s "[Sphinx] ($BASHPID) Building Language EN FAILED." $admin_mail_address
fi


echo -n "$(date) [apply_new_content.sh] ($BASHPID) Building /locales/ ..." >> /var/www/sphinx/logs_sphinx/webhook.log

# generate language files and push
sphinx-build -b gettext . ./locales/
sphinx-intl update -p ./locales/ -l de -l fr -l es -l nl -l it -l ja -l ru -l zh_CN -l el -l bg -l da -l et -l fi -l lv -l lt -l pl -l pt -l ro -l sv -l sk -l sl -l cs -l hu
if [ $? -eq 0 ]
then
	echo "$(date) [apply_new_content.sh] ($BASHPID) Building /locales/ ...DONE" >> /var/www/sphinx/logs_sphinx/webhook.log
else
	echo "$(date) [apply_new_content.sh] ($BASHPID) Building /locales/ ...FAILED" >> /var/www/sphinx/logs_sphinx/webhook.log
	echo "Building  /locales/ FAILED." | mail -s "[Sphinx] Building Locales FAILED." $admin_mail_address

fi

echo "$(date) [apply_new_content.sh] ($BASHPID) Pushing upstream ..." >> /var/www/sphinx/logs_sphinx/webhook.log

git add --all
git commit -m "Language Files generated by Sphinx ($BASHPID)"
git push

echo "$(date) [apply_new_content.sh] ($BASHPID) Pushing upstream ...DONE" >> /var/www/sphinx/logs_sphinx/webhook.log

echo "Waiting 60 seconds for weblate to pull new content before triggering deepl"
sleep 60

source ../trigger_deepl_apikey.sh
echo "$(date) [apply_new_content.sh] ($BASHPID) Trigger deepl translation..." >> /var/www/sphinx/logs_sphinx/webhook.log
bash trigger_deepl.sh $apikey >> /var/www/sphinx/logs_sphinx/trigger_deepl.log
echo "$(date) [apply_new_content.sh] ($BASHPID) Trigger deepl translation...done" >> /var/www/sphinx/logs_sphinx/webhook.log

